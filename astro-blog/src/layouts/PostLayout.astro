---
import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ToC from '../components/ToC.astro';
import PostMeta from '../components/PostMeta.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import type { BlogPost } from '../lib/supabase';
import { getMetaTitle, getMetaDescription, getOgImage, getCanonicalUrl, generateBlogPostingSchema, generateBreadcrumbSchema } from '../lib/seo';
import { extractHeadings } from '../lib/text';

interface Props {
  post: BlogPost;
  relatedPosts: BlogPost[];
}

const { post, relatedPosts } = Astro.props;

const title = getMetaTitle(post);
const description = getMetaDescription(post);
const canonical = getCanonicalUrl(post.slug);
const ogImage = getOgImage(post);
const headings = extractHeadings(post.content_md);

const schemas = [
  generateBlogPostingSchema(post),
  generateBreadcrumbSchema(post)
];
---

<BaseLayout 
  title={title}
  description={description}
  canonical={canonical}
  ogImage={ogImage}
  ogType="article"
  publishedTime={post.publish_at || undefined}
  modifiedTime={post.updated_at}
  author={post.author_name || "Equipo VistaCEO"}
  schemas={schemas}
>
  <Header />
  
  <main class="post-container">
    <article class="post-article">
      <header class="post-header">
        <h1>{post.title}</h1>
        <PostMeta post={post} />
      </header>
      
      {post.excerpt && (
        <div class="post-takeaways">
          <h2>ðŸ“Œ Puntos Clave</h2>
          <p>{post.excerpt}</p>
        </div>
      )}
      
      {headings.length > 2 && (
        <ToC headings={headings} />
      )}
      
      <div class="post-content" set:html={post.content_md} />
      
      <footer class="post-footer">
        <div class="post-cta">
          <h3>Â¿QuerÃ©s tomar mejores decisiones de negocio?</h3>
          <p>VistaCEO es tu copiloto de IA para PyMEs latinoamericanas. Probalo gratis.</p>
          <a href="https://www.vistaceo.com" class="cta-button" target="_blank" rel="noopener">
            Conocer VistaCEO â†’
          </a>
        </div>
      </footer>
    </article>
    
    {relatedPosts.length > 0 && (
      <RelatedPosts posts={relatedPosts} currentCluster={post.pillar} />
    )}
  </main>
  
  <Footer />
</BaseLayout>
